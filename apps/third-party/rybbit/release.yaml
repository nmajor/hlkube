apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: rybbit
  namespace: rybbit
spec:
  interval: 15m
  timeout: 30m
  chart:
    spec:
      chart: rybbit
      version: "0.4.23"
      sourceRef:
        kind: HelmRepository
        name: rybbit
        namespace: flux-system
  install:
    remediation:
      retries: 3
    timeout: 30m
  upgrade:
    remediation:
      retries: 3
    timeout: 30m
  # Merge sensitive values from sealed secret
  valuesFrom:
    - kind: Secret
      name: rybbit-helm-values
      valuesKey: values.yaml
  values:
    # Backend configuration
    backend:
      enabled: true
      replicaCount: 1
      image:
        repository: ghcr.io/rybbit-io/rybbit-backend
        tag: latest
      resources:
        requests:
          cpu: 200m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      # Reference to the BETTER_AUTH_SECRET from our sealed secret
      betterSecret:
        secretName: rybbit-secrets
        authKey: better_auth_secret
      env:
        # External PostgreSQL (CloudNativePG)
        POSTGRES_HOST: rybbit-postgres-rw
        POSTGRES_PORT: "5432"
        POSTGRES_DB: rybbit
        POSTGRES_USER: rybbit
        # POSTGRES_PASSWORD is injected from rybbit-helm-values secret
        # Base URL for the application
        BASE_URL: https://rybbit.nmajor.net
        # Disable public signup after initial setup (optional)
        # DISABLE_SIGNUP: "true"

    # Client (frontend) configuration
    client:
      enabled: true
      replicaCount: 1
      image:
        repository: ghcr.io/rybbit-io/rybbit-client
        tag: latest
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 300m
          memory: 256Mi
      env:
        NEXT_PUBLIC_BACKEND_URL: https://rybbit.nmajor.net
        # NEXT_PUBLIC_DISABLE_SIGNUP: "true"

    # Disable built-in PostgreSQL (we use CloudNativePG)
    postgresql:
      enabled: false

    # Enable ClickHouse subchart
    clickhouse:
      enabled: true
      image:
        registry: docker.io
        repository: bitnami/clickhouse
        tag: latest
      auth:
        username: default
        # Password will be auto-generated by the chart
      keeper:
        image:
          registry: docker.io
          repository: bitnami/clickhouse
          tag: latest
      persistence:
        enabled: true
        size: 40Gi
        storageClass: longhorn
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi

    # Disable built-in ingress (we use Traefik IngressRoute)
    ingress:
      api:
        enabled: false
      client:
        enabled: false
